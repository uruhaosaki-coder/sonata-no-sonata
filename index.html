<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- タイトル変更 -->
    <title>そなたのソナタ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            scroll-behavior: smooth;
        }
        
        /* 選択中のボタンスタイル (通常のCSS) */
        /* !important を追加して、Tailwindの bg-white より優先させる */
        .track-button.selected {
            background-color: #D3C34A !important; /* 黄色 */
            color: #1B2A5C !important;       /* 濃い青文字 */
            border: 4px solid #fde68a;
            font-weight: bold;
        }

        /* ふりがな(ruby)スタイル */
        .track-button ruby {
            line-height: 1.2; /* 行間を詰める */
            -webkit-ruby-position: over;
            ruby-position: over;
        }
        .track-button rt {
            font-size: 0.7rem; /* ふりがなサイズ */
            font-weight: normal; /* ふりがなは太字にしない */
            color: #374151; /* 少し薄い文字色 */
        }
        /* 選択中のふりがなの色 */
        .track-button.selected rt {
             color: #1B2A5C;
        }
    </style>
</head>
<!-- 背景を #717071 (グレー) に変更 -->
<body class="bg-[#717071] flex items-center justify-center min-h-screen p-4">

    <!-- カードの背景色を #1B2A5C (濃い青) に変更 -->
    <div class="w-full max-w-2xl bg-[#1B2A5C] rounded-lg shadow-xl p-6">
        
        <!-- タイトル「①きみ の ピンチ に あった きょく を さがそう！」 -->
        <h1 class="text-2xl font-bold text-center text-[#D3C34A] mb-4">
            ①きみ の ピンチ に あった きょく を さがそう！
        </h1>

        <!-- トラック選択ボタン (8曲・4列) -->
        <div id="button-container" class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-4 w-full">
            <template id="track-button-template">
                <!-- min-h-[70px] と py-2 でふりがな用の高さを確保 -->
                <button class="track-button text-[#1B2A5C] font-bold py-2 px-1 rounded-lg bg-white hover:bg-gray-100 transition-all duration-200 shadow-md text-sm border-4 border-transparent min-h-[70px] flex items-center justify-center">
                    <!-- この中身(innerHTML)はJavaScriptによって <ruby>... に置き換えられます -->
                </button>
            </template>
        </div>

        <!-- 案内文「②えらんだら、さいせい ボタン を おして きいてみよう！」 -->
        <h2 class="text-xl font-bold text-center text-[#D3C34A] mb-6">
            ②えらんだら、さいせい ボタン を おして きいてみよう！
        </h2>

        <!-- 操作ボタン -->
        <div class="flex space-x-4">
            <!-- さいせいボタンの色とテキストを変更 -->
            <button id="play-button" class="flex-1 bg-[#9AB700] hover:bg-opacity-80 text-white font-bold py-4 px-6 rounded-lg text-lg shadow-lg transition duration-300">
                さいせい
            </button>
            <!-- とめるボタンの色とテキストを変更 -->
            <button id="stop-button" class="flex-1 bg-[#AC220D] hover:bg-opacity-80 text-white font-bold py-4 px-6 rounded-lg text-lg shadow-lg transition duration-300">
                とめる
            </button>
        </div>

        <!-- ステータス表示 (明るいグレー) -->
        <div id="status" class="text-center text-gray-300 mt-4 h-6"></div>

        <!-- コピーライト追加 -->
        <footer class="text-center text-gray-400 text-xs mt-6">
            ©︎ 探究学舎
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
        // --- ▼ 音源設定（8トラック・MP3・前後ジングル） ▼ ---
        
        // !【重要】このファイルは GitHub Pages にアップロードするためのものです。
        // ! このまま「プレビュー」しても "ファイルが見つからない" エラーになります。
        
        // 再生開始/終了時に鳴るジングル（実体は MP3）
        const A_URL = "wide_2511_music_209i_2846_kokyokyoku40_trim.mp3";
        const B_URL = "wide_2511_music_209i_2846_kokyokyoku40_trim.mp3";

        // 選択する8種類の音トラック (曲名とふりがな)
        const TRACK_DATA = [
            { name: "運命", ruby: "うんめい", file: "wide_2511_music_209a_audiostock_871154_unmei_triminBb.mp3" },
            { name: "冬", ruby: "ふゆ", file: "wide_2511_music_209b_audiostock_1531685_fuyu_triminBb.mp3" },
            { name: "月の光", ruby: "つきのひかり", file: "wide_2511_music_209c_audiostock_931505_tsukinohikari_triminBb.mp3" },
            { name: "G線上のアリア", ruby: "じーせんじょうのありあ", file: "wide_2511_music_209d_audiostock_821545_gsenjonoaria_triminBb.mp3" },
            { name: "カノン", ruby: "かのん", file: "wide_2511_music_209e_PachelbelCanoninD2019AR_canon_triminBb.mp3" },
            { name: "歓喜の歌", ruby: "かんきのうた", file: "wide_2511_music_209f_audiostock_147191_kankinouta_triminBb.mp3" },
            { name: "モルダウ", ruby: "もるだう", file: "wide_2511_music_209g_audiostock_1251719_morudau_triminBb.mp3" },
            { name: "新世界より", ruby: "しんせかいより", file: "wide_2511_music_209h_audiostock_1262384_shinsekai_triminBb.mp3" }
        ];
        // --- ▲ 音源設定 ▲ ---


        // Audioオブジェクトのインスタンス
        const audioA = new Audio();
        const audioB = new Audio();
        const audioMain = new Audio();
        const audioPreview = new Audio(); // プレビュー再生用

        // ▼ 互換性向上：事前読み込みと CORS を明示
        ;[audioA, audioB, audioMain, audioPreview].forEach(a => {
            a.preload = 'auto';
            a.crossOrigin = 'anonymous';
        });

        // ▼ GitHub Pages などでルート配下以外に置く場合のベースパス
        // 例: const BASE_PATH = '/sonata/';
        const BASE_PATH = '';
        const buildURL = (file) => {
            // ファイル名に () などの記号があるため念のためエンコード
            // すでにエンコード済みの部分は encodeURI が壊さない
            return BASE_PATH + encodeURI(file);
        };
        
        let currentSequencePlayers = [audioA, audioMain, audioB];
        let currentSequenceIndex = 0; // シーケンス再生のインデックス
        let isSequencePlaying = false; // シーケンス再生中フラグ

        // DOM要素
        const buttonContainer = document.getElementById('button-container');
        const playButton = document.getElementById('play-button');
        const stopButton = document.getElementById('stop-button');
        const statusEl = document.getElementById('status');
        const template = document.getElementById('track-button-template');

        let selectedTrackIndex = 0; // デフォルトでTrack 1 (インデックス 0) を選択
        let trackButtons = []; // ボタンの参照を保持する配列
        let isPreviewPlaying = false; // プレビュー再生中フラグ

        // --- 初期化 ---
        try {
            // トラックボタンを生成
            if (template && buttonContainer) {
                TRACK_DATA.forEach((track, index) => {
                    const clone = template.content ? template.content.cloneNode(true) : null;
                    let button;
                    if (clone) {
                        button = clone.querySelector('.track-button');
                    } else {
                        // ▼ template 未対応・無効環境のフォールバック
                        button = document.createElement('button');
                        button.className = 'track-button text-[#1B2A5C] font-bold py-2 px-1 rounded-lg bg-white hover:bg-gray-100 transition-all duration-200 shadow-md text-sm border-4 border-transparent min-h-[70px] flex items-center justify-center';
                    }

                    // ふりがな(ruby)タグを挿入
                    button.innerHTML = `<ruby>${track.name}<rt>${track.ruby}</rt></ruby>`;
                    button.dataset.index = index;
                    
                    button.addEventListener('click', () => {
                        updateButtonSelection(index);
                        playPreview(index);
                    });

                    if (clone) {
                        buttonContainer.appendChild(clone);
                    } else {
                        buttonContainer.appendChild(button);
                    }
                    trackButtons.push(button);
                });
            } else {
                throw new Error('button-container または track-button-template が見つかりません');
            }
        } catch (err) {
            console.error('初期化エラー:', err);
            statusEl.textContent = '初期化エラー：ボタン生成に失敗しました';
        }

        // 起動時にデフォルト（Track 1）を選択状態にする
        if (trackButtons.length > 0) {
            // updateButtonSelection(0); // ★修正★ 起動時のデフォルト選択を無効化
        }

        // --- ★★★ 修正箇所 ★★★ ---
        // --- ボタン選択状態の更新ロジック ---
        function updateButtonSelection(index) {
            if (index < 0 || index >= trackButtons.length) return; // 範囲外チェック

            selectedTrackIndex = index; // 現在選択中のインデックスを更新

            // すべてのボタンの選択状態を解除
            trackButtons.forEach((btn, i) => {
                if (i === index) {
                    // クリックされたボタンを選択状態にする
                    btn.classList.add('selected');
                } else {
                    // それ以外のボタンの選択状態を解除する
                    btn.classList.remove('selected');
                }
            });
        }
        // --- ★★★ 修正ここまで ★★★ ---


        // --- プレビュー再生ロジック ---
        function playPreview(index) {
            // まずシーケンス再生を止める
            stopAllAudio(false);

            // プレビュー用に読み込み→再生（canplaythrough を待って安定化）
            audioPreview.src = buildURL(TRACK_DATA[index].file);
            audioPreview.currentTime = 0;
            let played = false;
            const tryPlay = () => {
                if (played) return;
                played = true;
                audioPreview.play().catch(e => {
                    console.error('Preview Playback error:', e?.message || e);
                    statusEl.textContent = 'エラー (プレビュー): 読込失敗';
                });
            };
            const once = () => {
                audioPreview.removeEventListener('canplaythrough', once);
                tryPlay();
            };
            audioPreview.addEventListener('canplaythrough', once);
            // ネットワーク次第で canplaythrough が来ない環境向けフォールバック
            setTimeout(tryPlay, 500);
            audioPreview.load();

            statusEl.textContent = `${TRACK_DATA[index].name} をプレビュー中...`;
            isPreviewPlaying = true;
        }

        // --- シーケンス再生ロジック (ギャップレス版) ---
        playButton.addEventListener('click', startSequence);
        stopButton.addEventListener('click', () => stopAllAudio(true)); // メッセージを更新する

        // 1. 「さいせい」ボタンが押された時の処理
        function startSequence() {
            stopAllAudio(false); // まず全ての音を止める
            isSequencePlaying = true;
            currentSequenceIndex = 0;
            
            const urls = [
                A_URL,
                TRACK_DATA[selectedTrackIndex].file, // TRACK_DATA からファイル名を取得
                B_URL
            ];
            // ★修正★ 再生中のメッセージを A, B, C (提示部, 展開部, 再現部) に変更
            const names = [
                "提示部（ていじぶ）を再生中…", // A_URL
                "展開部（てんかいぶ）を再生中…", // TRACK_DATA
                "再現部（さいげんぶ）を再生中…"  // B_URL
            ];

            // 3つのプレイヤーを準備
            currentSequencePlayers.forEach((player, index) => {
                player.src = buildURL(urls[index]);
                player.dataset.name = names[index]; // デバッグ用に名前を保持

                // 最後のプレイヤー以外は、再生終了時に次のプレイヤーを呼ぶ
                if (index < currentSequencePlayers.length - 1) {
                    player.onended = () => {
                        if (isSequencePlaying) {
                            playNextInSequence(index + 1);
                        }
                    };
                } else {
                    // 最後のプレイヤー
                    player.onended = () => {
                        statusEl.textContent = "さいせい しゅうりょう";
                        isSequencePlaying = false;
                    };
                }
                
                player.onerror = (e) => {
                    handleAudioError(e, player.dataset.name);
                };
            });

            // 最初のプレイヤーの再生を開始
            playNextInSequence(0);
        }

        // 2. 次の音を再生する処理
        function playNextInSequence(index) {
            if (!isSequencePlaying || index >= currentSequencePlayers.length) {
                return; // 停止ボタンが押されたか、シーケンスが終了した
            }
            
            const player = currentSequencePlayers[index];
            const name = player.dataset.name;
            
            // ★修正★ statusEl.textContent = `${name} を さいせい中...`;
            statusEl.textContent = name; // ご指定のメッセージをそのまま表示
            console.log(`Playing ${name} (URL: ${player.src})`);

            player.currentTime = 0; // 念のため頭出し
            player.play().catch(e => {
                handleAudioError(e, name);
            });
        }

        // 3. エラーハンドリング
        function handleAudioError(e, name) {
            console.error(`Audio Playback Error (${name}):`, e);
            statusEl.textContent = `エラー (${name}): ファイル読込失敗`;
            stopAllAudio(false); // エラーが起きたら全停止
        }

        // 4. 「とめる」ボタンの処理
        function stopAllAudio(updateStatus) {
            // console.log("Stopping all audio");
            
            // シーケンス再生を停止
            isSequencePlaying = false;
            currentSequencePlayers.forEach(player => {
                player.pause();
                player.currentTime = 0;
                player.onended = null; // 予約解除
                player.onerror = null;
            });

            // プレビュー再生を停止
            isPreviewPlaying = false;
            audioPreview.pause();
            audioPreview.currentTime = 0;

            if (updateStatus) {
                statusEl.textContent = "とめました";
            }
        }
        
        }); // DOMContentLoaded
    </script>
</body>
</html>
