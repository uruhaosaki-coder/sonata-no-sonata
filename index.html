<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- タイトル変更 -->
    <title>そなたのソナタ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            scroll-behavior: smooth;
        }
        
        /* 選択中のボタンスタイル (通常のCSS) */
        /* !important を追加して、Tailwindの bg-white より優先させる */
        .track-button.selected {
            background-color: #D3C34A !important; /* 黄色 */
            color: #1B2A5C !important;           /* 濃い青文字 */
            border: 4px solid #fde68a;
            font-weight: bold;
        }

        /* ふりがな(ruby)スタイル */
        /* ★修正★ display:flex を削除し、ブラウザ標準のルビ表示(上に表示)に戻す */
        .track-button ruby {
            /* display: flex; */
            /* flex-direction: column; */
            line-height: 1.2; /* 行間を詰める */
            -webkit-ruby-position: over;
            ruby-position: over;
        }
        .track-button rt {
            font-size: 0.7rem; /* ふりがなサイズ */
            font-weight: normal; /* ふりがなは太字にしない */
            color: #374151; /* 少し薄い文字色 */
        }
        /* 選択中のふりがなの色 */
        .track-button.selected rt {
             color: #1B2A5C;
        }
    </style>
</head>
<!-- 背景を #717071 (グレー) に変更 -->
<body class="bg-[#717071] flex items-center justify-center min-h-screen p-4">

    <!-- カードの背景色を #1B2A5C (濃い青) に変更 -->
    <div class="w-full max-w-2xl bg-[#1B2A5C] rounded-lg shadow-xl p-6">
        
        <!-- タイトル「①きみ の ピンチ に あった きょく を さがそう！」 -->
        <h1 class="text-2xl font-bold text-center text-[#D3C34A] mb-4">
            ①きみ の ピンチ に あった きょく を さがそう！
        </h1>

        <!-- トラック選択ボタン (8曲・4列) -->
        <div id="button-container" class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-4 w-full">
            <template id="track-button-template">
                <!-- min-h-[70px] と py-2 でふりがな用の高さを確保 -->
                <button class="track-button text-[#1B2A5C] font-bold py-2 px-1 rounded-lg bg-white hover:bg-gray-100 transition-all duration-200 shadow-md text-sm border-4 border-transparent min-h-[70px] flex items-center justify-center">
                    <!-- この中身(innerHTML)はJavaScriptによって <ruby>... に置き換えられます -->
                </button>
            </template>
        </div>

        <!-- 案内文「②えらんだら、さいせい ボタン を おして きいてみよう！」 -->
        <h2 class="text-xl font-bold text-center text-[#D3C34A] mb-6">
            ②えらんだら、さいせい ボタン を おして きいてみよう！
        </h2>

        <!-- 操作ボタン -->
        <div class="flex space-x-4">
            <!-- さいせいボタンの色とテキストを変更 -->
            <button id="play-button" class="flex-1 bg-[#9AB700] hover:bg-opacity-80 text-white font-bold py-4 px-6 rounded-lg text-lg shadow-lg transition duration-300">
                さいせい
            </button>
            <!-- とめるボタンの色とテキストを変更 -->
            <button id="stop-button" class="flex-1 bg-[#AC220D] hover:bg-opacity-80 text-white font-bold py-4 px-6 rounded-lg text-lg shadow-lg transition duration-300">
                とめる
            </button>
        </div>

        <!-- ステータス表示 (明るいグレー) -->
        <div id="status" class="text-center text-gray-300 mt-4 h-6"></div>

        <!-- コピーライト追加 -->
        <footer class="text-center text-gray-400 text-xs mt-6">
            ©︎ 探究学舎
        </footer>
    </div>

    <script>
        // --- ▼ 音源設定 (8トラック・wav・i.wav) ▼ ---
        
        // !【重要】このファイルは GitHub Pages にアップロードするためのものです。
        // ! このまま「プレビュー」しても "ファイルが見つからない" エラーになります。
        
        // 再生開始/終了時に鳴る音 (i.wav)
        const A_URL = "i.wav";
        const B_URL = "i.wav";

        // 選択する8種類の音トラック (曲名とふりがな)
        const TRACK_DATA = [
            { name: "運命", ruby: "うんめい", file: "a.wav" },
            { name: "冬", ruby: "ふゆ", file: "b.wav" },
            { name: "月の光", ruby: "つきのひかり", file: "c.wav" },
            { name: "G線上のアリア", ruby: "じーせんじょうのありあ", file: "d.wav" },
            { name: "カノン", ruby: "かのん", file: "e.wav" },
            { name: "歓喜の歌", ruby: "かんきのうた", file: "f.wav" },
            { name: "モルダウ", ruby: "もるだう", file: "g.wav" },
            { name: "新世界より", ruby: "しんせかいより", file: "h.wav" }
        ];
        // --- ▲ 音源設定 ▲ ---


        // Audioオブジェクトのインスタンス
        const audioA = new Audio();
        const audioB = new Audio();
        const audioMain = new Audio();
        const audioPreview = new Audio(); // プレビュー再生用
        
        let currentSequencePlayers = [audioA, audioMain, audioB];
        let currentSequenceIndex = 0; // シーケンス再生のインデックス
        let isSequencePlaying = false; // シーケンス再生中フラグ

        // DOM要素
        const buttonContainer = document.getElementById('button-container');
        const playButton = document.getElementById('play-button');
        const stopButton = document.getElementById('stop-button');
        const statusEl = document.getElementById('status');
        const template = document.getElementById('track-button-template');

        let selectedTrackIndex = 0; // デフォルトでTrack 1 (インデックス 0) を選択
        let trackButtons = []; // ボタンの参照を保持する配列
        let isPreviewPlaying = false; // プレビュー再生中フラグ

        // --- 初期化 ---

        // トラックボタンを生成
        if (template && buttonContainer) {
            TRACK_DATA.forEach((track, index) => {
                const clone = template.content.cloneNode(true);
                const button = clone.querySelector('.track-button');
                
                // ★ふりがな(ruby)タグを挿入★
                button.innerHTML = `<ruby>${track.name}<rt>${track.ruby}</rt></ruby>`;
                button.dataset.index = index; 

                button.addEventListener('click', () => {
                    // ★スマホ対応修正★
                    // 1. まず色を変える（軽い処理）
                    updateButtonSelection(index);
                    // 2. 次に音を再生する（重い処理）
                    playPreview(index);
                });

                buttonContainer.appendChild(clone);
                trackButtons.push(button); 
            });
        } else {
            console.error("初期化エラー: button-container または track-button-template が見つかりません。");
            statusEl.textContent = "ボタンの初期化に失敗しました";
        }


        // トラック選択処理 (色を変えるだけ)
        function updateButtonSelection(index) {
            selectedTrackIndex = index;
            trackButtons.forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            // console.log(`Button selection updated to ${index}`);
        }
        
        // 起動時にデフォルト（Track 1）を選択状態にする
        updateButtonSelection(0);


        // --- プレビュー再生ロジック ---
        function playPreview(index) {
            // console.log(`Play preview for index ${index}`);
            // まずシーケンス再生を止める
            stopAllAudio(false); // メッセージは更新しない

            // プレビュー再生
            audioPreview.src = TRACK_DATA[index].file; // TRACK_DATA からファイル名を取得
            audioPreview.currentTime = 0;
            
            audioPreview.play().catch(e => {
                console.error(`Preview Playback error:`, e.message);
                statusEl.textContent = `エラー (プレビュー): 読込失敗`;
            });
            
            statusEl.textContent = `${TRACK_DATA[index].name} をプレビュー中...`;
            isPreviewPlaying = true;
        }

        // --- シーケンス再生ロジック (ギャップレス版) ---
        playButton.addEventListener('click', startSequence);
        stopButton.addEventListener('click', () => stopAllAudio(true)); // メッセージを更新する

        // 1. 「さいせい」ボタンが押された時の処理
        function startSequence() {
            stopAllAudio(false); // まず全ての音を止める
            isSequencePlaying = true;
            currentSequenceIndex = 0;
            
            const urls = [
                A_URL,
                TRACK_DATA[selectedTrackIndex].file, // TRACK_DATA からファイル名を取得
                B_URL
            ];
            const names = [
                "i.wav",
                TRACK_DATA[selectedTrackIndex].name, // TRACK_DATA から曲名を取得
                "i.wav"
            ];

            // 3つのプレイヤーを準備
            currentSequencePlayers.forEach((player, index) => {
                player.src = urls[index];
                player.dataset.name = names[index]; // デバッグ用に名前を保持

                // 最後のプレイヤー以外は、再生終了時に次のプレイヤーを呼ぶ
                if (index < currentSequencePlayers.length - 1) {
                    player.onended = () => {
                        if (isSequencePlaying) {
                            playNextInSequence(index + 1);
                        }
                    };
                } else {
                    // 最後のプレイヤー
                    player.onended = () => {
                        statusEl.textContent = "さいせい しゅうりょう";
                        isSequencePlaying = false;
                    };
                }
                
                player.onerror = (e) => {
                    handleAudioError(e, player.dataset.name);
                };
            });

            // 最初のプレイヤーの再生を開始
            playNextInSequence(0);
        }

        // 2. 次の音を再生する処理
        function playNextInSequence(index) {
            if (!isSequencePlaying || index >= currentSequencePlayers.length) {
                return; // 停止ボタンが押されたか、シーケンスが終了した
            }
            
            const player = currentSequencePlayers[index];
            const name = player.dataset.name;
            
            statusEl.textContent = `${name} を さいせい中...`;
            console.log(`Playing ${name} (URL: ${player.src})`);

            player.currentTime = 0; // 念のため頭出し
            player.play().catch(e => {
                handleAudioError(e, name);
            });
        }

        // 3. エラーハンドリング
        function handleAudioError(e, name) {
            console.error(`Audio Playback Error (${name}):`, e);
            statusEl.textContent = `エラー (${name}): ファイル読込失敗`;
            stopAllAudio(false); // エラーが起きたら全停止
        }

        // 4. 「とめる」ボタンの処理
        function stopAllAudio(updateStatus) {
            // console.log("Stopping all audio");
            
            // シーケンス再生を停止
            isSequencePlaying = false;
            currentSequencePlayers.forEach(player => {
                player.pause();
                player.currentTime = 0;
                player.onended = null; // 予約解除
                player.onerror = null;
            });

            // プレビュー再生を停止
            isPreviewPlaying = false;
            audioPreview.pause();
            audioPreview.currentTime = 0;

            if (updateStatus) {
                statusEl.textContent = "とめました";
            }
        }
        
    </script>
</body>
</html>
