<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>そなたのソナタ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            scroll-behavior: smooth;
        }
        
        /* 選択中のボタンスタイル (通常のCSS) */
        .track-button.selected {
            background-color: #D3C34A; /* 黄色 */
            color: #1B2A5C;            /* 濃い青文字 */
            border: 4px solid #fde68a; /* ring-yellow-200 の代わり */
            font-weight: bold;
            padding-top: 1rem;
            padding-bottom: 1rem;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }

        /* ボタンの文字サイズを自動調整 */
        .track-button {
            /* 1行で表示し、はみ出たら ... に */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            /* 文字サイズを少し小さくして長い曲名に対応 */
            font-size: 0.8rem; /* 14px -> 12.8px */
        }
    </style>
</head>
<!-- 背景を #717071 (グレー) に変更 -->
<body class="bg-[#717071] flex items-center justify-center min-h-screen p-4">

    <!-- カードの背景色を #1B2A5C (濃い青) に変更 -->
    <div class="w-full max-w-2xl bg-[#1B2A5C] rounded-lg shadow-xl p-6">
        <!-- タイトルの文字色を #D3C34A (黄色) に変更 -->
        <h1 class="text-2xl font-bold text-center text-[#D3C34A] mb-6">そなたのソナタ</h1>

        <!-- トラック選択ボタン (8曲用にレイアウト変更) -->
        <div id="button-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mb-6 w-full">
            <template id="track-button-template">
                <!-- Trackボタン: 白背景(bg-white)、青文字(text-[#1B2A5C]) -->
                <button class="track-button text-[#1B2A5C] font-bold py-4 px-2 rounded-lg bg-white hover:bg-gray-100 transition-all duration-200 shadow-md border-4 border-transparent">
                    Track
                </button>
            </template>
        </div>

        <!-- 操作ボタン -->
        <div class="flex space-x-4">
            <!-- ボタンの文字を「決まったらココをクリック！」に変更 -->
            <button id="play-button" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-lg text-lg shadow-lg transition duration-300">
                決まったらココをクリック！
            </button>
            <button id="stop-button" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-6 rounded-lg text-lg shadow-lg transition duration-300">
                停止
            </button>
        </div>

        <!-- ステータス表示 (明るいグレー) -->
        <div id="status" class="text-center text-gray-300 mt-4 h-6"></div>
    </div>

    <script>
        // --- ▼ 音源設定 (GitHub Pagesアップロード用) ▼ ---
        
        // !【重要】このファイルは GitHub Pages にアップロードするためのものです。
        // ! このまま「プレビュー」しても "ファイルが見つからない" というエラーになりますが、
        // ! これは正常な動作です。

        // 再生開始時に鳴る音 (i.wav に変更)
        const A_URL = "i.wav";

        // 再生終了時に鳴る音 (i.wav に変更)
        const B_URL = "i.wav";

        // 選択する8種類の音トラック (a.wav ~ h.wav に変更)
        const TRACK_URLS = [
            "a.wav", // Track 1
            "b.wav", // Track 2
            "c.wav", // Track 3
            "d.wav", // Track 4
            "e.wav", // Track 5
            "f.wav", // Track 6
            "g.wav", // Track 7
            "h.wav"  // Track 8
        ];

        // ▼ ボタンに表示する曲名 (8曲) ▼
        const TRACK_NAMES = [
            "運命",
            "冬",
            "月の光",
            "G線上のアリア",
            "カノン",
            "歓喜の歌",
            "モルダウ",
            "新世界より"
        ];
        // --- ▲ 音源設定 ▲ ---


        // Audioオブジェクトのインスタンス (使い回します)
        const audioA = new Audio();
        const audioB = new Audio();
        const audioMain = new Audio(); // シーケンス再生用
        const audioPreview = new Audio(); // プレビュー再生専用
        
        // ▼ 削除 (新しいロジックでは不要)
        // let currentSequence = []; 
        // let currentPlayingAudio = null;
        let currentPreviewAudio = null; // 現在プレビュー中のAudioオブジェクト

        // DOM要素
        const buttonContainer = document.getElementById('button-container');
        const playButton = document.getElementById('play-button');
        const stopButton = document.getElementById('stop-button');
        const statusEl = document.getElementById('status');
        const template = document.getElementById('track-button-template');

        let selectedTrackIndex = 0; // デフォルトでTrack 1 (インデックス 0) を選択
        let trackButtons = []; // ボタンの参照を保持する配列

        // --- 初期化 ---
        
        // このif文は、<template> タグが正しく読み込まれたか確認するためのものです
        if (template && buttonContainer) {
            // トラックボタンを生成
            TRACK_URLS.forEach((url, index) => {
                const clone = template.content.cloneNode(true);
                const button = clone.querySelector('.track-button');
                
                // ▼ 曲名を表示するように変更 ▼
                // TRACK_NAMES配列に曲名があればそれを使い、なければ元の "Track X" を使う
                button.textContent = TRACK_NAMES[index] || `Track ${index + 1}`;
                button.dataset.index = index; 

                button.addEventListener('click', () => {
                    // トラックボタンクリックでプレビュー再生
                    playPreview(index);
                });

                buttonContainer.appendChild(clone);
                trackButtons.push(button); 
            });
        } else {
            console.error("初期化エラー: button-container または track-button-template が見つかりません。");
            statusEl.textContent = "ボタンの初期化に失敗しました";
        }


        // トラックの選択状態（色）だけを更新する
        function updateButtonSelection(index) {
            selectedTrackIndex = index;
            trackButtons.forEach((btn, i) => {
                // 'selected' クラス (黄色の背景) の付け外し
                btn.classList.toggle('selected', i === index);
            });
        }
        
        // 起動時にデフォルト（Track 1）を選択状態にする (音は鳴らさない)
        // trackButtonsが正しく生成された場合のみ実行
        if (trackButtons.length > 0) {
            updateButtonSelection(0);
        }


        // --- 再生ロジック ---

        playButton.addEventListener('click', playSequence);
        stopButton.addEventListener('click', stopAllAudio);

        // トラックボタン（プレビュー）のロジック
        function playPreview(index) {
            // まずは選択状態（色）を更新
            updateButtonSelection(index);

            // もし同じトラックがすでにプレビュー再生中なら、停止する
            if (currentPreviewAudio && currentPreviewAudio.dataset.index == index && !currentPreviewAudio.paused) {
                currentPreviewAudio.pause();
                currentPreviewAudio.currentTime = 0;
                currentPreviewAudio = null;
                statusEl.textContent = `${TRACK_NAMES[index]} プレビュー停止`;
                return;
            }

            // 他の音（シーケンスまたはプレビュー）をすべて停止
            stopAllAudio(true); // true = プレビュー停止中であることを示す

            const url = TRACK_URLS[index];
            currentPreviewAudio = audioPreview; // プレビュー用のAudioオブジェクトを使用
            currentPreviewAudio.src = url;
            currentPreviewAudio.dataset.index = index; // どのトラックか記録

            currentPreviewAudio.removeEventListener('ended', previewEnded);
            currentPreviewAudio.removeEventListener('error', handleAudioError);

            currentPreviewAudio.addEventListener('ended', previewEnded);
            currentPreviewAudio.addEventListener('error', (e) => handleAudioError(e, `Preview ${TRACK_NAMES[index]}`));
            
            statusEl.textContent = `${TRACK_NAMES[index]} をプレビュー中...`;
            console.log(`Playing Preview ${TRACK_NAMES[index]} (URL: ${url})`);
            
            currentPreviewAudio.play().catch(e => {
                console.error(`Playback error (Preview ${TRACK_NAMES[index]}):`, e.message);
                statusEl.textContent = `再生エラー (Preview)`;
            });
        }

        function previewEnded() {
            statusEl.textContent = "プレビュー終了";
            currentPreviewAudio = null;
        }

        // ▼ 修正: 再生ボタン（シーケンス）のロジック
        function playSequence() {
            // 他の音（プレビューなど）をすべて停止
            stopAllAudio(); 

            // 1. 再生するURLを取得
            const urlA = A_URL;
            const urlMain = TRACK_URLS[selectedTrackIndex];
            const urlB = B_URL;
            const mainTrackName = TRACK_NAMES[selectedTrackIndex];

            // 2. すべてのAudioオブジェクトにsrcを設定 (ブラウザが先読みを開始できます)
            audioA.src = urlA;
            audioMain.src = urlMain;
            audioB.src = urlB;

            // 3. 古いイベントリスナーをすべてクリア
            audioA.onended = null;
            audioMain.onended = null;
            audioB.onended = null;
            audioA.onerror = null;
            audioMain.onerror = null;
            audioB.onerror = null;

            // 4. 再生を「リレー式」につなげる
            
            // A (i.wav) が終わったら
            audioA.onended = () => {
                statusEl.textContent = `${mainTrackName} を再生中...`;
                console.log(`Playing Main (URL: ${urlMain})`);
                audioMain.play().catch(e => handlePlaybackError(e, mainTrackName));
            };

            // Main (選択トラック) が終わったら
            audioMain.onended = () => {
                statusEl.textContent = `B (i.wav) を再生中...`;
                console.log(`Playing B (URL: ${urlB})`);
                audioB.play().catch(e => handlePlaybackError(e, "B (i.wav)"));
            };

            // B (i.wav) が終わったら
            audioB.onended = () => {
                statusEl.textContent = "再生終了";
                console.log("Sequence finished");
            };

            // 5. 各オーディオのエラーハンドリング
            audioA.onerror = (e) => handlePlaybackError(e, "A (i.wav)");
            audioMain.onerror = (e) => handlePlaybackError(e, mainTrackName);
            audioB.onerror = (e) => handlePlaybackError(e, "B (i.wav)");

            // 6. 最初のA (i.wav) の再生を開始
            statusEl.textContent = "A (i.wav) を再生中...";
            console.log(`Playing A (URL: ${urlA})`);
            audioA.play().catch(e => handlePlaybackError(e, "A (i.wav)"));
        }

        // ▼ 削除 (古いシーケンスロジック)
        // function playNextInSequence() { ... }

        // ▼ 修正: エラーハンドリング (シーケンス全体を停止させる)
        function handlePlaybackError(e, name) {
            console.error(`Playback error (${name}):`, e.message);
            statusEl.textContent = `再生エラー (${name})`;
            stopAllAudio(true); // エラー発生時はすべてを停止
        }
        
        // ▼ 削除 (古いエラーハンドラ)
        // function handleAudioError(e, name) { ... }


        // ▼ 修正: 停止ボタン（すべて停止）のロジック
        function stopAllAudio(isErrorStop = false, isPreviewStop = false) {
            // シーケンス再生を停止
            [audioA, audioB, audioMain].forEach(audio => {
                if (audio) {
                    audio.pause();
                    audio.currentTime = 0;
                    // ▼ 修正: チェーンされたイベントをクリア
                    audio.onended = null; 
                    audio.onerror = null;
                }
            });
            // (currentSequence, currentPlayingAudio は削除済み)

            // プレビュー再生を停止
            if (audioPreview) {
                audioPreview.pause();
                audioPreview.currentTime = 0;
                audioPreview.removeEventListener('ended', previewEnded);
                audioPreview.removeEventListener('error', handleAudioError);
            }
            currentPreviewAudio = null;
            
            if (isErrorStop) {
                // エラーメッセージを上書きしない
            } else if (!isPreviewStop) { // プレビュー停止（内部呼び出し）の時はメッセージを変えない
                statusEl.textContent = "停止しました";
            }
            console.log("All audio stopped");
        }
    </script>
</body>
</html>
